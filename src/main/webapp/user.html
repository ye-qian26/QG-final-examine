<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户界面</title>
    <style>
        .avatar-uploader .el-upload {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .avatar-uploader .el-upload:hover {
            border-color: #409EFF;
        }
        .avatar-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 178px;
            height: 178px;
            line-height: 178px;
            text-align: center;
        }
        .avatar {
            width: 178px;
            height: 178px;
            display: block;
        }
        .post-card {
            margin-bottom: 20px;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .post-image {
            width: 10%;
            height: auto;
            margin-bottom: 10px;
        }

        .post-content {
            line-height: 1.5;
        }

    </style>

</head>
<body>
<div id="app">
    <el-menu
            :default-active="activeIndex"
            class="el-menu-demo"
            mode="horizontal"
            @select="handleSelect"
            background-color="#545c64"
            text-color="#fff"
            active-text-color="#ffd04b">
        <el-menu-item index="1">主页</el-menu-item>

        <el-menu-item index="2">我的板块</el-menu-item>

        <el-menu-item index="3">个人信息中心</el-menu-item>
    </el-menu>

    <!--主页-->
    <div v-if="activeIndex === '1'">
        <h1>主页内容</h1>
        <p>这里可以放置系统公告、常用功能快捷入口等。</p>


    </div>

    <!--我的板块-->
    <div v-if="activeIndex === '2'">
        <h1>我的板块</h1>
        <el-button type="primary" @click="createPlateDialogVisible=true">创建板块</el-button>
        <el-tabs v-model="activeTab" @tab-click="selectPostByPlateId">
            <el-tab-pane v-for="(plate, index) in plateDate" :key="index" :label="plate.name" :name="plate.id">
                <el-button type="primary" @click="createPostDialogVisible=true">发布帖子</el-button>
                <el-card class="post-card" v-for="post in postData" :key="post.id">
                    <template #header>
                        <div class="post-header">
                            <span>{{ post.username }}</span>
                            <div class="action-buttons">
                                <el-button icon="el-icon-star" :class="{ 'is-active': post.isFavorited }" @click="toggleFavorite(post)">
                                    {{ post.isFavorited ? '已收藏' : '收藏' }}
                                </el-button>
                                <el-button icon="el-icon-thumbs" :class="{ 'is-active': post.isLiked }" @click="toggleLike(post)">
                                    {{ post.likes }} 赞
                                </el-button>
                            </div>
                        </div>
                    </template>
                    <img :src="post.image" alt="Post Image" class="post-image" />
                    <div class="post-content">{{ post.content }}</div>
                </el-card>
            </el-tab-pane>
        </el-tabs>
    </div>

    <!--个人信息中心-->
    <div class="info" v-if="activeIndex === '3'">
        <h1>个人信息中心</h1>
        <div v-if="user.role === '1'">
            <p>身份：普通用户</p>
        </div>
        <div v-else-if="user.role === '2'">
            <p>身份：管理员</p>
        </div>
        <el-upload
                class="avatar-uploader"
                action="http://localhost:8080/Technical-Forum/userServlet/uploadAvatar"
                :show-file-list="false"
                :on-success="handleAvatarSuccess"
                :before-upload="beforeAvatarUpload"
                :data="{id : user.id}">
            <el-image v-if="user.headPortrait" :src="user.headPortrait" class="avatar"></el-image>
            <i v-else class="el-icon-plus avatar-uploader-icon"></i>
        </el-upload>
        <el-form :model="form" label-width="120px" :rules="rules">
            <el-form-item label="昵称" prop="name">
                <el-input v-model="form.name" ></el-input>
            </el-form-item>
            <el-form-item>
                <el-button type='primary' @click="updateUsername">保存</el-button>
            </el-form-item>
        </el-form>
        <el-button type='primary' @click="updateDialogVisible=true">设置密码</el-button>
        <div v-if="user.role==='1'">
            <!--普通用户-->
            <el-button type="info" @click="infoClick1">信息通知</el-button>
        </div>
        <div v-else-if="user.role==='2'">
            <!--管理员-->
            <el-button type="info" @click="infoClick2">信息通知</el-button>
        </div>
    </div>

    <!--设置密码对话框-->
    <el-dialog
            title="设置密码"
            :visible.sync="updateDialogVisible"
            :before-close="handleClosePwd"
            width="30%"
            class="update-password-dialog"
    >
        <el-form ref="form1" :model="form" :rules="rules" label-width="80px">
            <el-form-item label="手机号" prop="tele">
                <el-input v-model="form.tele" disabled></el-input>
            </el-form-item>
            <el-form-item label="原密码" prop="password">
                <el-input placeholder="填写原密码" v-model="form.password" show-password></el-input>
            </el-form-item>
            <el-form-item label="新密码" prop="newPassword">
                <el-input placeholder="填写新密码" type="password" v-model="form.newPassword" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="确认密码" prop="checkPassword">
                <el-input placeholder="再次填写确认" type="password" v-model="form.checkPassword" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="updatePassword('form1')">提交</el-button>
                <el-button @click="handleClosePwd">取消</el-button>
            </el-form-item>
        </el-form>

    </el-dialog>
    <!--管理员信息通知对话框-->
    <el-dialog
            title="信息通知"
            :visible.sync="infoDialogVisible"
            :before-close="handleCloseInfo"
            width="60%"
    >
        <el-table
                :data="infoData"
                height="400"
                stripe
                style="width: 100%">
            <el-table-column
                    prop="userId"
                    label="用户id"
                    width="100">
            </el-table-column>
            <el-table-column
                    prop="username"
                    label="用户昵称"
                    width="150">
            </el-table-column>
            <el-table-column
                    prop="plateName"
                    label="欲创建板块名称"
                    width="150">
            </el-table-column>
            <el-table-column
                    prop="statusStr"
                    label="状态"
                    width="120">
            </el-table-column>
            <el-table-column
                    align="center"
                    label="操作">
                <el-row slot-scope="scope">
                    <div v-if="scope.row.statusStr==='未处理'">
                        <el-button type="primary" @click="allowAudit(scope.row)">允许</el-button>
                        <el-button type="danger" plain @click="unallowAudit(scope.row)">不允许</el-button>
                    </div>
                    <div v-else-if="scope.row.statusStr==='已处理'">
                        <el-button type="success" @click="deleteAuditById(scope.row)">清理</el-button>
                    </div>
                </el-row>
            </el-table-column>

        </el-table>
    </el-dialog>

    <!--创建板块对话框-->
    <el-dialog
            title="创建板块"
            :visible.sync="createPlateDialogVisible"
            :before-close="handleClosePlate"
            width="30%"
    >
        <el-form ref="form2" :model="form2" :rules="rules" label-width="80px">
            <el-form-item label="板块名称" prop="plateName">
                <el-input v-model="form2.plateName"></el-input>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="createPlate('form2')">提交</el-button>
                <el-button @click="handleClosePlate">取消</el-button>
            </el-form-item>
        </el-form>
    </el-dialog>

    <!--发布帖子对话框-->
    <el-dialog
            title="发布帖子"
            :visible.sync="createPostDialogVisible"
            :before-close="handleClosePost"
            width="30%"
    >
        <el-form ref="form3" :model="form3" :rules="rules" label-width="80px">
            <el-form-item label="图片" prop="image">
                <el-upload
                        action="http://localhost:8080/Technical-Forum/postServlet/uploadAvatar"
                        :show-file-list="false"
                        :on-success="handleSuccess"
                        :before-upload="beforeAvatarUpload"
                >
                    <el-button size="small" type="primary">上传图片</el-button>
                </el-upload>
                <el-image v-if="form3.image" :src="form3.image" style="max-width: 100px; max-height: 100px;"></el-image>
            </el-form-item>
            <el-form-item label="帖子内容" prop="postContent">
                <el-input type="textarea" v-model="form3.content"></el-input>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="createPost('form3')">提交</el-button>
                <el-button @click="handleClosePost">取消</el-button>
            </el-form-item>
        </el-form>
    </el-dialog>
</div>

<script src="js/vue.js"></script>
<script src="element-ui/lib/index.js"></script>
<script src="js/axios-0.18.0.js"></script>
<link rel="stylesheet" href="element-ui/lib/theme-chalk/index.css">

<script>
    new Vue({
        el: '#app',
        mounted(){
            console.log(this.user.username);
            this.selectPlateByUserId();
        },
        data() {
            //制定密码规则
            var validatePass = (rule, value, callback) => {
                if (value === '') {
                    callback(new Error('请输入密码'));
                } else {
                    if (this.checkPassword !== '') {
                        this.$refs.form.validateField('checkPassword');
                    }
                    callback();
                }
            };
            var validatePass2 = (rule, value, callback) => {
                if (value === '') {
                    callback(new Error('请再次输入密码'));
                } else if (value !== this.form.newPassword) {
                    callback(new Error('两次输入密码不一致!'));
                } else {
                    callback();
                }
            };
            return {
                //用户数据
                user: {
                    id: localStorage.getItem('id'),
                    username: localStorage.getItem('username'),
                    tele: localStorage.getItem('tele'),
                    password: '',
                    headPortrait: localStorage.getItem('headPortrait'),
                    role: localStorage.getItem('role')
                },
                //板块数据
                plate:{
                    id:'',
                    name:'',
                    userId:'',
                    notice:'',
                    pageView:'',
                    likes:''
                },
                //帖子数据
                post:{
                    id:'',
                    content:'',
                    image:'',
                    pageView:'',
                    likes:'',
                    plateId:'',
                    userId:'',
                    isLiked: false,
                    isFavorited: false
                },
                //申请数据
                audit:{
                    id:'',
                    userId:'',
                    plateName:'',
                    status:'0'
                },
                //表单数据
                form: {
                    name: localStorage.getItem('username'),
                    tele: localStorage.getItem('tele'),
                    role: localStorage.getItem('role'),
                    password: '',
                    newPassword:'',
                    checkPassword:''
                },
                form2: {
                    plateName:''
                },
                form3: {
                    content:'',
                    image:''
                },
                //信息表格
                infoData: [],
                //帖子集合
                postData: [],
                //板块集合
                plateDate: [],
                //临时信息表格
                _infoData: [],
                //导航菜单索引
                activeIndex: '2',
                //头像url路径
                imageUrl: '',
                //设置密码对话框
                updateDialogVisible:false,
                //创建板块对话框
                createPlateDialogVisible:false,
                //信息通知对话框
                infoDialogVisible:false,
                //发布帖子对话框
                createPostDialogVisible:false,
                //确认密码
                checkPassword:'',
                //用户ID到用户名的映射对象
                userMap:{},
                //标签导航
                activeTab: '',
                //输入规则
                rules: {
                    //昵称
                    name: [
                        { required: true, message: '请输入昵称', trigger: 'blur' }
                    ],
                    //板块名
                    plateName: [
                        { required: true, message: '板块名不能为空', trigger: 'blur' }
                    ],
                    //帖子内容
                    postContent: [
                        { required: true, message: '请输入内容', trigger: 'blur' }
                    ],
                    //图片
                    image: [
                        { required: true, message: '请上传图片', trigger: 'blur' }
                    ],
                    //密码规则
                    password: [
                        { required: true, message: '请输入密码', trigger: 'blur' },
                        { min: 8, max: 12, message: '长度需在8到12个字符之间', trigger: 'blur'}
                    ],
                    //密码规则
                    newPassword: [
                        { min: 8, max: 12, message: '长度需在8到12个字符之间', trigger: 'blur'},
                        { validator: validatePass, trigger: 'blur' }
                    ],
                    //再次输入密码规则
                    checkPassword: [
                        { validator: validatePass2, trigger: 'blur'}
                    ]
                },
            }
        },
        methods: {
            handleSelect(key) {
                this.activeIndex = key;
            },
            handleAvatarSuccess(res) {
                if (res.success) {
                    this.user.headPortrait = res.data.headPortraitPath;
                    //改变localStorage里面存储的信息
                    localStorage.setItem("headPortrait", this.user.headPortrait)
                    this.$message({
                        type:'success',
                        message:'上传头像成功！'
                    })
                } else {
                    this.$message.error('上传头像失败，请稍后再试');
                }
            },
            handleSuccess(res) {
                if (res.success) {
                    this.form3.image = res.data.headPortraitPath;
                    this.$message({
                        type:'success',
                        message:'上传图片成功！'
                    })
                } else {
                    this.$message.error('上传图片失败，请稍后再试');
                }
            },
            beforeAvatarUpload(file) {
                const isJPG = file.type === 'image/jpeg';
                const isLt2M = file.size / 1024 / 1024 < 2;

                if (!isJPG) {
                    this.$message.error('上传头像图片只能是 JPG 格式!');
                }
                if (!isLt2M) {
                    this.$message.error('上传头像图片大小不能超过 2MB!');
                }
                return isJPG && isLt2M;
            },
            //关闭对话框
            handleClosePwd(){
                this.updateDialogVisible = false;
                //重置表单中的密码信息
                this.form.password = '';
                this.form.newPassword = '';
                this.form.checkPassword = '';
            },
            handleCloseInfo(){
                this.infoDialogVisible = false;
            },
            handleClosePlate(){
                this.createPlateDialogVisible = false;
            },
            handleClosePost(){
                this.createPostDialogVisible = false;
            },
            //点击信息通知事件
            infoClick2(){
                this.selectAllAudit();
                this.infoDialogVisible = true;
            },
            //修改昵称
            updateUsername() {
                this.user.username = this.form.name;
                //使用 axios 发送请求
                axios({
                    method:'get',
                    url:'http://localhost:8080/Technical-Forum/userServlet/updateUsername?'
                    + "username=" + this.user.username + "&id=" + this.user.id
                }).then(resp => {
                    if (resp.data === 'success') {
                        //修改成功
                        localStorage.setItem("username", this.user.username)
                        this.$message.success('昵称保存成功');
                    }
                })
            },
            //修改密码
            updatePassword(formName){
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        //判断原密码是否正确
                        axios({
                            method:'get',
                            url:'http://localhost:8080/Technical-Forum/userServlet/loginUser?'
                            + "tele=" + this.user.tele + "&password=" + this.form.password
                        }).then(resp => {
                            if (resp.data !== 'fail'){
                                //原密码正确
                                //修改密码
                                axios({
                                    method:'get',
                                    url:'http://localhost:8080/Technical-Forum/userServlet/updateUserPassword?'
                                    + "password=" + this.form.newPassword + "&id=" + this.user.id
                                }).then(resp => {
                                    if (resp.data === 'success'){
                                        //修改成功
                                        this.$message.success('设置密码成功！');
                                    } else {
                                        //修改失败
                                        this.$message.error('请求失败，请稍后重试！');
                                    }
                                    //关闭对话框
                                    this.handleClosePwd();
                                })
                            } else {
                                //原密码错误
                                this.$message.error('原密码错误！')
                            }
                        })

                    }else {
                        console.log('error submit!!');
                        return false;
                    }
                })
            },
            //用户创建板块
            createPlate(formName){
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        //存储到申请表中，等待管理员审核
                        this.audit.userId = this.user.id;
                        this.audit.plateName = this.form2.plateName;
                        axios({
                            method:'post',
                            url:'http://localhost:8080/Technical-Forum/auditServlet/addAudit',
                            data: this.audit
                        }).then(resp => {
                            if (resp.data === 'success'){
                                //添加成功
                                //消息提示
                                this.$message.success('已发送申请，请等待系统管理员审核...');
                                //关闭对话框
                                this.handleClosePlate();
                            }
                        })
                    } else {
                        console.log('error submit!!');
                        return false;
                    }
                })
            },
            //查询所有申请
            async selectAllAudit(){
                try {
                    const resp = await axios({
                        method: 'get',
                        url: 'http://localhost:8080/Technical-Forum/auditServlet/selectAllAudit'
                    });
                    // 查询成功
                    this._infoData = resp.data;
                    // 构建用户ID到用户名的映射对象
                    this.userMap = await this.buildUserMap(this._infoData);
                    // 替换userId为用户名
                    this.replaceUserIdWithUsername();
                    this.infoData = this._infoData;
                    console.log(this.userMap);
                    console.log(this.infoData);
                } catch (error) {
                    console.error('查询申请时出错', error);
                }
            },
            //构建用户ID到用户名的映射对象
            async buildUserMap(infoData) {
                const userMap = {};
                for (const info of infoData) {
                    try {
                        const resp = await axios({
                            //发送ajax请求
                            method: 'get',
                            url: 'http://localhost:8080/Technical-Forum/userServlet/selectUserById',
                            params: { id: info.userId }
                        });
                        if (resp.data!== 'fail') {
                            userMap[info.userId] = resp.data.username;
                        }
                    } catch (error) {
                        console.error('获取用户信息时出错', error);
                    }
                }
                return userMap;
            },
            //替换userId为用户名
            replaceUserIdWithUsername() {
                this._infoData.forEach(info => {
                    console.log(this.userMap['2']);
                    info.username = this.userMap[info.userId] || '未知用户';
                });

            },
            //管理员允许创建板块
            allowAudit(row){
                this.$confirm('确定允许该用户创建对应板块吗?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    axios({
                        method:'get',
                        url:'http://localhost:8080/Technical-Forum/plateServlet/addPlate',
                        params: {userId : row.userId, name : row.plateName}
                    }).then(resp => {
                        if (resp.data === 'success') {
                            //板块创建成功
                            this.$message.success('该板块创建成功！');
                            this.updateAuditStatus(row.id);
                        }
                    })
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消允许'
                    });
                });
            },
            //删除申请信息
            deleteAuditById(row){
                this.$confirm('确认清理该数据吗?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    axios({
                        method:'get',
                        url:'http://localhost:8080/Technical-Forum/auditServlet/deleteAuditById',
                        params: {id : row.id}
                    }).then(resp => {
                        if (resp.data === 'success'){
                            //删除成功
                            this.$message.success('清理成功！')
                            //重新加载信息表格
                            this.selectAllAudit();
                        }
                    })
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消清理'
                    });
                });
            },
            //修改申请状态
            updateAuditStatus(id){
                axios({
                    method:'get',
                    url:'http://localhost:8080/Technical-Forum/auditServlet/updateAuditStatus',
                    params: {id : id}
                }).then(resp => {
                    if(resp.data === 'success'){
                        //修改成功
                        //重新加载信息表格
                        this.selectAllAudit();
                    }
                })
            },
            //通过用户id查询板块
            selectPlateByUserId(){
                axios({
                    method:'get',
                    url:'http://localhost:8080/Technical-Forum/plateServlet/selectPlateByUserId',
                    params:{userId : this.user.id}
                }).then(resp => {
                    if (resp.data !== 'fail'){
                        //有数据
                        this.plateDate = resp.data;
                    } else {
                        //无数据
                        this.$notify.info({
                            title: '消息',
                            message: '暂无所创建板块~'
                        });
                    }
                })
            },
            //切换标签页（根据plateId查询对应post）
            selectPostByPlateId() {
                axios({
                    method:'get',
                    url:'http://localhost:8080/Technical-Forum/postServlet/selectPostByPlateId',
                    params: {plateId : this.activeTab}
                }).then(resp => {
                    if (resp.data !== 'fail') {
                        //有数据
                        this.postData = resp.data;
                    } else {
                        //无数据
                        //该板块暂无帖子
                        this.$notify.info({
                            title: '消息',
                            message: '该板块暂无帖子~'
                        });
                    }
                })
            },
            //添加帖子
            createPost(){

            },
            // 切换点赞状态
            toggleLike(post){
                post.isLiked = !post.isLiked;
                if (post.isLiked) {
                    post.likes++;
                } else {
                    post.likes--;
                }
            },
            // 切换收藏状态
            toggleFavorite(post){
                post.isFavorited = !post.isFavorited;
            }
        }
    })


</script>
</body>
</html>